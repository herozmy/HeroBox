--- START OF FILE public/index.html ---
<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HeroBox 控制台</title>
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <div id="app"></div>
    <script type="module" src="/src/main.js"></script>
  </body>
</html>
--- END OF FILE public/index.html ---

--- START OF FILE public/styles.css ---
:root {
  color-scheme: light dark;
  --sidebar-width: 220px;
  --brand: #1f7aec;
  --brand-soft: rgba(31, 122, 236, 0.12);
  --border: rgba(0, 0, 0, 0.08);
  font-family: 'SF Pro Display', 'PingFang SC', 'Microsoft YaHei', sans-serif;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  min-height: 100vh;
  background: #f6f8fb;
  color: #1f2b3a;
}

#app {
  display: flex; /* Ensure the Vue app container takes up the full layout */
  min-height: 100vh;
}

.layout {
  display: flex;
  min-height: 100vh;
  width: 100%; /* Ensure layout takes full width of #app */
}

.sidebar {
  width: var(--sidebar-width);
  background: #101826;
  color: #fff;
  display: flex;
  flex-direction: column;
  padding: 24px 16px;
  flex-shrink: 0;
}

.logo {
  font-weight: 600;
  font-size: 20px;
  letter-spacing: 0.02em;
  margin-bottom: 32px;
}

/* Base nav button styles */
.nav-btn {
  width: 100%;
  padding: 12px;
  border: none;
  background: transparent;
  color: inherit;
  text-align: left;
  border-radius: 10px;
  font-size: 15px;
  cursor: pointer;
  transition: background 0.2s ease;
  display: block;
  text-decoration: none;
}

.nav-btn.active,
.nav-btn:hover {
  background: rgba(255, 255, 255, 0.12);
}

.nav-group {
  margin-top: 16px;
}

.nav-btn--parent {
  cursor: pointer; /* Changed to pointer for click events */
  font-weight: 600;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.nav-caret {
  font-size: 12px;
  opacity: 0.8;
  transition: transform 0.2s ease;
}

.nav-sub {
  margin: 12px 0 24px 12px;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.nav-sub__btn {
  border: none;
  background: transparent;
  color: rgba(255, 255, 255, 0.7);
  text-align: left;
  padding: 8px 12px;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.2s ease;
}

.nav-sub__btn.active,
.nav-sub__btn:hover {
  background: rgba(255, 255, 255, 0.12);
  color: #fff;
}

.content {
  flex: 1;
  padding: 32px 40px;
  display: flex;
  flex-direction: column;
  gap: 24px;
}

.content__header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.content__header h1 {
  font-size: 26px;
}

.empty-state {
  border: 1px dashed var(--border);
  border-radius: 12px;
  padding: 48px;
  text-align: center;
  color: #6b7a90;
  background: #fff;
}

.cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 24px;
  grid-auto-rows: 1fr;
  align-items: stretch;
}

.card {
  background: #fff;
  border-radius: 16px;
  padding: 24px;
  box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
  border: 1px solid rgba(15, 23, 42, 0.08);
  display: flex;
  flex-direction: column;
  min-height: 0;
}

.card h2 {
  font-size: 18px;
  margin-bottom: 16px;
}

.cards--lists {
  grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
}

.card--lists {
  gap: 16px;
}

.list-tabs {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.list-tab {
  border: 1px solid var(--border);
  border-radius: 999px;
  padding: 6px 14px;
  background: #fff;
  cursor: pointer;
  font-size: 13px;
}

.list-tab.active {
  background: var(--brand);
  color: #fff;
  border-color: var(--brand);
}

.greylist-toolbar {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  align-items: center;
}

.greylist-input {
  flex: 1;
  min-width: 240px;
  padding: 10px 12px;
  border: 1px solid var(--border);
  border-radius: 10px;
  font-size: 14px;
}

.list-textarea {
  width: 100%;
  min-height: 280px;
  border-radius: 12px;
  border: 1px solid var(--border);
  padding: 16px;
  font-size: 13px;
  font-family: "SFMono-Regular", Consolas, "Courier New", monospace;
  resize: vertical;
  background: #fdfdfd;
}

.card__header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
  margin-bottom: 16px;
}

.card__actions {
  display: flex;
  gap: 10px;
}

.setting-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
  margin-top: 12px;
}

.switch {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
  cursor: pointer;
}

.switch input[type="checkbox"] {
  width: 18px;
  height: 18px;
  accent-color: var(--brand);
}

.status-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  margin-right: 8px;
}

.status {
  display: inline-flex;
  align-items: center;
  font-weight: 500;
}

.status-meta {
  list-style: none;
  margin: 16px 0 0;
  padding: 0;
  display: flex;
  flex-direction: column;
  gap: 6px;
  font-size: 13px;
  color: #4a5568;
}

.status-meta__label {
  color: #6b7a90;
  margin-right: 8px;
}

.status-meta__value {
  color: #1f2b3a;
  word-break: break-all;
}

.status-meta li {
  display: flex;
  justify-content: space-between;
  gap: 12px;
}

.status.online .status-dot {
  background: #0fba81;
}

.status.offline .status-dot {
  background: #f2555a;
}

.status.missing .status-dot {
  background: #f5a524;
}

.muted {
  color: #6b7a90;
  font-size: 13px;
  margin-top: 4px;
}

.button-row {
  display: flex;
  gap: 12px;
  margin-top: auto;
  padding-top: 18px;
}

.btn {
  flex: 1;
  padding: 0 16px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: #fff;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.2s ease;
  height: 44px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.btn.primary {
  background: var(--brand);
  color: #fff;
  border-color: var(--brand);
}

.btn.soft {
  background: var(--brand-soft);
  color: var(--brand);
  border-color: transparent;
}

.version-tag {
  font-size: 32px;
  font-weight: 600;
}

.log-list {
  margin-top: 12px;
  max-height: 260px;
  overflow-y: auto;
  border: 1px solid rgba(15, 23, 42, 0.08);
  border-radius: 12px;
  padding: 12px;
  background: #f8fafc;
  font-family: "SFMono-Regular", Consolas, "Courier New", monospace;
  font-size: 13px;
}

.log-item {
  display: flex;
  gap: 12px;
  padding: 6px 0;
  border-bottom: 1px solid rgba(15, 23, 42, 0.08);
}

.log-item:last-child {
  border-bottom: none;
}

.log-item time {
  color: #64748b;
  min-width: 140px;
}

.log-item span {
  flex: 1;
}

/* AlertBanner styles - these can be component-specific if preferred */
.alert {
  border-radius: 10px;
  padding: 12px 16px;
  border: 1px solid rgba(0, 0, 0, 0.08);
  background: #f4f6fb;
  color: #1f2b3a;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
}

.alert--success {
  border-color: rgba(15, 186, 129, 0.4);
  background: rgba(15, 186, 129, 0.1);
}

.alert--error {
  border-color: rgba(242, 85, 90, 0.4);
  background: rgba(242, 85, 90, 0.08);
}

.alert--info {
  border-color: rgba(31, 122, 236, 0.3);
  background: rgba(31, 122, 236, 0.08);
}

.alert__close {
  border: none;
  background: transparent;
  color: inherit;
  font-size: 18px;
  cursor: pointer;
  line-height: 1;
}

/* Modal styles - these can be component-specific if preferred */
.modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(15, 23, 42, 0.65);
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 20px;
  z-index: 999;
}

.modal {
  width: min(420px, 100%);
  background: #fff;
  border-radius: 18px;
  padding: 28px;
  box-shadow: 0 24px 60px rgba(15, 23, 42, 0.25);
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.modal__header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
}

.modal h3 {
  margin: 0;
  font-size: 20px;
}

.modal__actions {
  width: 100%;
  margin-top: 8px;
}

.modal--logs {
  width: min(640px, 100%);
}

.modal__logs {
  max-height: 360px;
}

.modal__input {
  width: 100%;
  padding: 10px 14px;
  border-radius: 10px;
  border: 1px solid rgba(15, 23, 42, 0.15);
  font-size: 14px;
  outline: none;
}

.modal__input:focus {
  border-color: var(--brand);
  box-shadow: 0 0 0 2px rgba(31, 122, 236, 0.15);
}

.modal__textarea {
  width: 100%;
  min-height: 280px;
  border-radius: 12px;
  border: 1px solid rgba(15, 23, 42, 0.15);
  padding: 12px;
  font-family: 'SFMono-Regular', Consolas, 'Courier New', monospace;
  font-size: 13px;
  outline: none;
  resize: vertical;
  background: #f8fafc;
}

.preview-layout {
  display: flex;
  gap: 12px;
  width: 100%;
}

.preview-tree {
  width: 220px;
  border: 1px solid rgba(15, 23, 42, 0.08);
  border-radius: 10px;
  padding: 8px;
  background: #f8fafc;
  display: flex;
  flex-direction: column;
  gap: 4px;
  max-height: 360px;
  overflow-y: auto;
}

.preview-node {
  border: none;
  background: transparent;
  text-align: left;
  padding: 4px 6px;
  border-radius: 6px;
  font-size: 13px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 6px;
}

.preview-node.active {
  background: var(--brand-soft);
  color: var(--brand);
}

.preview-node__icon {
  width: 16px;
  text-align: center;
  font-size: 11px;
  color: #64748b;
}

.preview-layout .modal__textarea {
  flex: 1;
  min-height: 320px;
}

.config-preferences {
  margin-top: 16px;
  padding: 16px;
  border: 1px solid var(--border);
  border-radius: 12px;
  background: #fdfdfd;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.config-preferences__row {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.config-preferences__row label {
  font-size: 13px;
  color: #6b7a90;
}

.config-preferences__row input {
  padding: 10px 12px;
  border-radius: 10px;
  border: 1px solid var(--border);
  font-size: 14px;
}

.guide-log {
  max-height: 400px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 16px;
  padding-right: 8px;
}

.guide-log__entry h4 {
  margin-bottom: 6px;
  font-size: 14px;
  color: #1f2b3a;
}

.guide-card__list {
  margin-left: 16px;
  color: #1f2b3a;
  font-size: 14px;
  list-style: none;
  padding: 0;
  margin: 0;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.guide-step {
  display: flex;
  gap: 12px;
  align-items: flex-start;
}

.guide-step__status {
  width: 22px;
  height: 22px;
  border-radius: 50%;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  font-size: 13px;
  border: 1px solid var(--border);
}

.guide-step__status.success {
  background: #e6fbf3;
  border-color: #0fba81;
  color: #0f7b56;
}

.guide-step__status.pending {
  background: #fff7e6;
  border-color: #f5a524;
  color: #a56307;
}

.guide-step__content p {
  margin: 2px 0 0;
  color: #6b7a90;
  font-size: 13px;
}

@media (max-width: 768px) {
  .layout {
    flex-direction: column;
  }

  .sidebar {
    width: 100%;
    flex-direction: row;
    align-items: center;
    gap: 12px;
    padding: 16px;
  }

  .nav-btn {
    text-align: center;
    flex: 1;
  }

  .sidebar nav {
    width: 100%;
    display: flex;
    gap: 8px;
  }

  .content {
    padding: 20px;
  }

  .card {
    padding: 20px;
  }
}

@media (max-width: 520px) {
  .cards {
    grid-template-columns: 1fr;
  }

  .button-row {
    flex-direction: column;
    gap: 10px;
  }

  .btn {
    width: 100%;
  }

  .content__header {
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
  }

  .preview-layout {
    flex-direction: column;
  }

  .preview-tree {
    width: 100%;
    max-height: 220px;
  }
}
--- END OF FILE public/styles.css ---

--- START OF FILE src/main.js ---
import { createApp, reactive, provide } from 'vue';
import App from './App.vue';
import router from './router';

// Global state for banners, can be provided to all components
const globalState = reactive({
  banner: null,
});

const app = createApp(App);

app.use(router);

// Provide global state to all components
app.provide('globalState', globalState);

app.mount('#app');
--- END OF FILE src/main.js ---

--- START OF FILE src/router/index.js ---
import { createRouter, createWebHistory } from 'vue-router';
import Dashboard from '../views/Dashboard.vue';
import MosdnsPage from '../views/Mosdns/MosdnsPage.vue';

const routes = [
  {
    path: '/',
    name: 'Dashboard',
    component: Dashboard,
  },
  {
    path: '/mosdns',
    name: 'Mosdns',
    component: MosdnsPage,
    // MosdnsPage internally manages 'overview' and 'lists' sections
  },
];

const router = createRouter({
  history: createWebHistory(),
  routes,
});

export default router;
--- END OF FILE src/router/index.js ---

--- START OF FILE src/api.js ---
const API_BASE_URL = ''; // Assume same origin or configure proxy in vite.config.js

export async function apiRequest(path, options = {}) {
  const headers = Object.assign({}, options.headers);
  if (!(options.body instanceof FormData)) {
    headers['Content-Type'] = headers['Content-Type'] || 'application/json';
  }

  const resp = await fetch(`${API_BASE_URL}${path}`, {
    credentials: 'same-origin',
    ...options,
    headers,
  });

  let payload = null;
  try {
    payload = await resp.json();
  } catch (err) {
    // If response is not JSON, might be plain text or empty
    try {
      payload = await resp.text();
    } catch (textErr) {
      payload = null;
    }
  }

  if (!resp.ok) {
    const message = (payload && (payload.error || payload.message || payload)) || resp.statusText;
    throw new Error(message || '请求失败');
  }
  return payload;
}

// Specific API functions
export const getServiceStatus = () => apiRequest('/api/services/mosdns');
export const getMosdnsLogs = () => apiRequest('/api/mosdns/logs');
export const getMosdnsConfigStatus = () => apiRequest('/api/mosdns/config');
export const getSettings = () => apiRequest('/api/settings');
export const saveSettings = (settings) => apiRequest('/api/settings', {
  method: 'PUT',
  body: JSON.stringify(settings),
});
export const startMosdns = () => apiRequest('/api/services/mosdns/start', { method: 'POST' });
export const stopMosdns = () => apiRequest('/api/services/mosdns/stop', { method: 'POST' });
export const restartMosdns = () => apiRequest('/api/services/mosdns/restart', { method: 'POST' });
export const getLatestMosdnsKernel = () => apiRequest('/api/mosdns/kernel/latest');
export const updateMosdnsKernel = () => apiRequest('/api/mosdns/kernel/update', { method: 'POST' });
export const downloadMosdnsConfig = () => apiRequest('/api/mosdns/config/download', { method: 'POST' });
export const updateConfigPath = (path) => apiRequest('/api/mosdns/config', {
  method: 'PUT',
  body: JSON.stringify({ path }),
});
export const getMosdnsConfigContent = () => apiRequest('/api/mosdns/config/content');
export const saveMosdnsConfigFile = (file, content) => apiRequest(`/api/mosdns/config/file?file=${encodeURIComponent(file)}`, {
  method: 'PUT',
  body: JSON.stringify({ path: file, content }),
});
export const getListContent = (tag) => apiRequest(`/api/mosdns/lists/${tag}`);
export const saveListContent = (tag, values) => apiRequest(`/api/mosdns/lists/${tag}`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ values }),
});
export const updateAdguardRules = () => apiRequest('/api/mosdns/adguard/update', { method: 'POST' });

// Utility functions from original mosdns.js
export const LATEST_VERSION_CACHE_KEY = 'herobox.mosdns.latestVersion';

export const DEFAULT_FAKEIP_RANGE = 'f2b0::/18';
export const DEFAULT_DOMESTIC_DNS = '114.114.114.114';
export const DEFAULT_SOCKS5_ADDRESS = '127.0.0.1:7891';
export const DEFAULT_PROXY_INBOUND = '127.0.0.1:7874';
export const DEFAULT_FORWARD_ECS = '2408:8214:213::1';

export const SETTINGS_FIELDS = Object.freeze({
  fakeIpRange: DEFAULT_FAKEIP_RANGE,
  domesticDns: DEFAULT_DOMESTIC_DNS,
  socks5Address: DEFAULT_SOCKS5_ADDRESS,
  proxyInboundAddress: DEFAULT_PROXY_INBOUND,
  forwardEcsAddress: DEFAULT_FORWARD_ECS,
});

export const createSettingsState = (overrides = {}) => ({
  ...SETTINGS_FIELDS,
  enableSocks5: true, // DEFAULT_SOCKS5_ENABLED
  ...overrides,
});

export const createPreferencesDraft = (settings = createSettingsState()) => ({
  fakeIpRange: settings.fakeIpRange,
  domesticDns: settings.domesticDns,
  socks5Address: settings.socks5Address,
  proxyInboundAddress: settings.proxyInboundAddress,
  forwardEcsAddress: settings.forwardEcsAddress,
});

export const normalizeTextValue = (value) => {
  if (value == null) return '';
  return String(value).trim();
};

export const normalizeSettingsPayload = (source = {}) => {
  const normalized = createSettingsState();
  Object.keys(SETTINGS_FIELDS).forEach((key) => {
    if (!Object.prototype.hasOwnProperty.call(source, key)) return;
    const text = normalizeTextValue(source[key]);
    if (key === 'socks5Address') {
      normalized[key] = text;
    } else {
      normalized[key] = text || SETTINGS_FIELDS[key];
    }
  });
  const socks5Address = normalizeTextValue(normalized.socks5Address);
  normalized.enableSocks5 = Boolean(socks5Address);
  normalized.socks5Address = normalized.enableSocks5 ? socks5Address : '';
  return normalized;
};

export const normalizeBool = (value, fallback) => {
  if (typeof value === 'boolean') return value;
  if (typeof value === 'string') {
    const lowered = value.toLowerCase();
    if (lowered === 'true') return true;
    if (lowered === 'false') return false;
  }
  return fallback;
};

export const formatTime = (value) => {
  if (!value) return '-';
  const date = value instanceof Date ? value : new Date(value);
  if (Number.isNaN(date.getTime())) return '-';
  return date.toLocaleString('zh-CN', { hour12: false });
};

export const normalizeTag = (release) => {
  if (!release) return '';
  return release.tag_name || release.tagName || release.name || '';
};

export const LIST_DEFINITIONS = Object.freeze([
  { tag: 'whitelist', name: '白名单', placeholder: '例如 example.com 或 full:example.com' },
  { tag: 'blocklist', name: '黑名单', placeholder: '支持 full:domain 或通配符' },
  { tag: 'greylist', name: '灰名单', placeholder: '例如 grey.domain.com' },
  { tag: 'ddnslist', name: 'DDNS 域名', placeholder: '每行一个 DDNS 域名' },
  { tag: 'client_ip', name: '客户端 IP', placeholder: 'CIDR 或单个 IP，例如 192.168.1.2' },
]);

export const MOSDNS_API_ENDPOINTS = Object.freeze([
  { label: '最新发布 API', url: 'https://api.github.com/repos/yyysuo/mosdns/releases/latest' },
  { label: '指定版本 API', url: 'https://api.github.com/repos/yyysuo/mosdns/releases/tags/v5-ph-srs' },
  { label: '发布页面', url: 'https://github.com/yyysuo/mosdns/releases/tag/v5-ph-srs' },
  { label: '资源清单页', url: 'https://github.com/yyysuo/mosdns/releases/expanded_assets/v5-ph-srs' },
  { label: '默认重启端点', url: 'http://127.0.0.1:9099/api/v1/system/restart' },
]);
--- END OF FILE src/api.js ---

--- START OF FILE src/App.vue ---
<script setup>
import { ref, watch, provide } from 'vue';
import { useRouter, useRoute } from 'vue-router';
import AlertBanner from './components/AlertBanner.vue';

const router = useRouter();
const route = useRoute();

const mosdnsNavExpanded = ref(false);

const banner = ref(null);
const setBanner = (type, text) => {
  if (!text) return;
  banner.value = { type, text, ts: Date.now() };
};
// Provide setBanner function to child components
provide('setBanner', setBanner);

// Clear banner after some time
watch(banner, (newVal) => {
  if (newVal) {
    setTimeout(() => {
      banner.value = null;
    }, 5000);
  }
});
</script>

<template>
  <div class="layout">
    <aside class="sidebar">
      <div class="logo">HeroBox</div>
      <nav>
        <router-link to="/" class="nav-btn" :class="{ active: route.path === '/' }">
          仪表盘
        </router-link>
        <div class="nav-group">
          <button
            class="nav-btn nav-btn--parent"
            :class="{ active: route.path.startsWith('/mosdns') }"
            type="button"
            @click="mosdnsNavExpanded = !mosdnsNavExpanded"
            :aria-expanded="mosdnsNavExpanded ? 'true' : 'false'"
          >
            <span>Mosdns</span>
            <span class="nav-caret" :style="{ transform: mosdnsNavExpanded ? 'rotate(90deg)' : 'rotate(0deg)' }">▸</span>
          </button>
          <div class="nav-sub" v-show="mosdnsNavExpanded || route.path.startsWith('/mosdns')">
            <router-link
              to="/mosdns?section=overview"
              class="nav-sub__btn"
              :class="{ active: route.path.startsWith('/mosdns') && route.query.section !== 'lists' }"
            >
              总览
            </router-link>
            <router-link
              to="/mosdns?section=lists"
              class="nav-sub__btn"
              :class="{ active: route.path.startsWith('/mosdns') && route.query.section === 'lists' }"
            >
              名单管理
            </router-link>
          </div>
        </div>
      </nav>
    </aside>

    <main class="content">
      <AlertBanner v-if="banner" :type="banner.type" :message="banner.text" @close="banner = null" />
      <router-view />
    </main>
  </div>
</template>

<style scoped>
/* Scoped styles for App.vue, if any.
   Most layout/base styles are in public/styles.css
*/
.nav-caret {
  transform: rotate(0deg); /* Default state */
}
.nav-btn--parent[aria-expanded="true"] .nav-caret {
  transform: rotate(90deg);
}

/* Example of adding some specific styles */
.nav-btn.active {
    background: rgba(255, 255, 255, 0.2); /* Slightly different active state for clarity */
}
</style>
--- END OF FILE src/App.vue ---

--- START OF FILE src/components/AlertBanner.vue ---
<script setup>
import { defineProps, defineEmits } from 'vue';

const props = defineProps({
  type: {
    type: String,
    default: 'info', // 'success', 'error', 'info'
  },
  message: {
    type: String,
    required: true,
  },
});

const emit = defineEmits(['close']);

const onClose = () => {
  emit('close');
};
</script>

<template>
  <div class="alert" :class="`alert--${type}`">
    <span>{{ message }}</span>
    <button class="alert__close" @click="onClose">×</button>
  </div>
</template>

<style scoped>
/* No specific scoped styles needed if base styles are in global.css */
</style>
--- END OF FILE src/components/AlertBanner.vue ---

--- START OF FILE src/components/BaseModal.vue ---
<script setup>
import { defineProps, defineEmits } from 'vue';

const props = defineProps({
  title: String,
  modelValue: Boolean, // For v-model
  size: {
    type: String,
    default: 'default', // 'default', 'logs', 'large' etc.
  },
});

const emit = defineEmits(['update:modelValue', 'close']);

const closeModal = () => {
  emit('update:modelValue', false);
  emit('close');
};
</script>

<template>
  <div v-if="modelValue" class="modal-backdrop" @click.self="closeModal">
    <div class="modal" :class="`modal--${size}`">
      <div class="modal__header" v-if="title || $slots.header">
        <h3 v-if="title">{{ title }}</h3>
        <slot name="header">
          <button class="alert__close" @click="closeModal">×</button>
        </slot>
      </div>
      <slot></slot>
      <div class="button-row modal__actions" v-if="$slots.actions">
        <slot name="actions"></slot>
      </div>
    </div>
  </div>
</template>

<style scoped>
/* Scoped styles specific to BaseModal if needed, otherwise global.css */
</style>
--- END OF FILE src/components/BaseModal.vue ---

--- START OF FILE src/components/ProgressBar.vue ---
<script setup>
import { defineProps } from 'vue';

const props = defineProps({
  progress: {
    type: Number,
    default: 0, // 0-100
  },
});
</script>

<template>
  <div class="progress">
    <div class="progress__inner" :style="{ width: progress + '%' }"></div>
  </div>
</template>

<style scoped>
.progress {
  width: 100%;
  height: 6px;
  background: #edf1f7;
  border-radius: 999px;
  overflow: hidden;
  margin-top: 12px;
}

.progress__inner {
  height: 100%;
  background: var(--brand);
  border-radius: 999px;
  transition: width 0.2s ease;
}
</style>
--- END OF FILE src/components/ProgressBar.vue ---

--- START OF FILE src/views/Dashboard.vue ---
<script setup>
// No script needed for this simple empty state
</script>

<template>
  <header class="content__header">
    <div>
      <div class="muted">基础信息</div>
      <h1>仪表盘</h1>
    </div>
    <button class="btn soft" disabled>记录操作</button>
  </header>

  <section>
    <div class="empty-state">
      <h2>仪表盘仍在搭建中</h2>
      <p>未来将补充全局运行概览、告警摘要与代理拓扑。</p>
    </div>
  </section>
</template>

<style scoped>
/* Scoped styles for Dashboard.vue */
</style>
--- END OF FILE src/views/Dashboard.vue ---

--- START OF FILE src/views/Mosdns/MosdnsPage.vue ---
<script setup>
import { ref, reactive, computed, onMounted, onUnmounted, watch, provide, inject } from 'vue';
import { useRoute } from 'vue-router';
import {
  apiRequest,
  getServiceStatus,
  getMosdnsLogs,
  getMosdnsConfigStatus,
  getSettings,
  saveSettings,
  startMosdns,
  stopMosdns,
  restartMosdns,
  getLatestMosdnsKernel,
  updateMosdnsKernel,
  downloadMosdnsConfig,
  updateConfigPath,
  getMosdnsConfigContent,
  saveMosdnsConfigFile,
  getListContent,
  saveListContent,
  updateAdguardRules,
  LATEST_VERSION_CACHE_KEY,
  DEFAULT_FAKEIP_RANGE,
  DEFAULT_DOMESTIC_DNS,
  DEFAULT_SOCKS5_ADDRESS,
  DEFAULT_PROXY_INBOUND,
  DEFAULT_FORWARD_ECS,
  createSettingsState,
  createPreferencesDraft,
  normalizeTextValue,
  normalizeSettingsPayload,
  normalizeBool,
  formatTime,
  normalizeTag,
  LIST_DEFINITIONS,
  MOSDNS_API_ENDPOINTS,
} from '../../api.js';

import BaseModal from '../../components/BaseModal.vue';
import ProgressBar from '../../components/ProgressBar.vue';
import MosdnsOverview from './MosdnsOverview.vue';
import MosdnsListManagement from './MosdnsListManagement.vue';

const route = useRoute();
const setBanner = inject('setBanner');

// --- Mosdns Section State ---
const mosdnsSection = ref('overview'); // 'overview' or 'lists'
watch(() => route.query.section, (newSection) => {
  mosdnsSection.value = newSection || 'overview';
}, { immediate: true });

// --- Global Modals State ---
const showInfoModal = reactive({
  open: false,
  title: '',
  message: '',
});
const logsModalOpen = ref(false);
const configEditModalOpen = ref(false);
const downloadConfirmOpen = ref(false);
const guideLogModalOpen = ref(false);
const preferencesModalOpen = ref(false);
const previewModalOpen = ref(false);

const openModal = (title, message) => {
  showInfoModal.title = title || '提示';
  showInfoModal.message = message || '';
  showInfoModal.open = true;
};
const closeModal = () => {
  showInfoModal.open = false;
};

// --- General Component State & Methods (moved from original mosdns.js) ---
const mosdns = reactive({
  status: 'unknown',
  running: false,
  lastUpdated: '-',
  version: '-',
  latestVersion: '-',
  checking: false,
});
const config = reactive({
  path: '/etc/herobox/mosdns/config.yaml',
  lastSynced: '-',
  exists: true,
});
const logsEntries = ref([]);
const uiSettings = reactive({
  autoRefreshLogs: true,
});
const settingsForm = reactive(createSettingsState());
const preferencesDraft = reactive(createPreferencesDraft());

const actionPending = ref(false);
const pendingAction = ref('');
const updatePending = ref(false);
const stateLoading = ref(false);
const logsLoading = ref(false);
const configEditValue = ref('');
const configSaving = ref(false);
const settingsLoading = ref(false);
const settingsSaving = ref(false);
const autoRefreshTimer = ref(null);
const previewTree = ref([]);
const previewFlatList = ref([]);
const previewExpanded = reactive({});
const previewActiveFile = ref('');
const previewEditingContent = ref('');
const previewDir = ref('');
const previewLoading = ref(false);
const previewError = ref('');
const previewSaving = ref(false);
const previewSaveProgress = ref(0);
const configDownloading = ref(false);
const configDownloadProgress = ref(0);
const guideHistory = ref([]);
const settingsSaveProgress = ref(0);

const progressTickers = reactive({});

const startProgressTicker = (key, options = {}) => {
  const { initial = 10, step = 5, max = 90, interval = 300 } = options;
  stopProgressTicker(key);
  progressTickers[`${key}Value`] = initial; // Store value on a different key
  progressTickers[key] = setInterval(() => {
    if (typeof progressTickers[`${key}Value`] !== 'number') {
      progressTickers[`${key}Value`] = initial;
      return;
    }
    if (progressTickers[`${key}Value`] < max) {
      progressTickers[`${key}Value`] += step;
    }
  }, interval);
};

const stopProgressTicker = (key, finalValue = 0) => {
  if (typeof finalValue === 'number') {
    progressTickers[`${key}Value`] = finalValue; // Update the value key
  }
  if (progressTickers[key]) {
    clearInterval(progressTickers[key]);
    delete progressTickers[key];
  }
};

const stopAllProgressTickers = () => {
  Object.keys(progressTickers).forEach((key) => {
    if (key.endsWith('Value')) return; // Ignore value refs
    stopProgressTicker(key);
  });
};

const restoreLatestVersion = () => {
  try {
    const cached = window.localStorage.getItem(LATEST_VERSION_CACHE_KEY);
    if (cached) {
      mosdns.latestVersion = cached;
    }
  } catch (err) {
    console.error("Local storage error:", err);
  }
};

const persistLatestVersion = (tag) => {
  if (!tag) return;
  try {
    window.localStorage.setItem(LATEST_VERSION_CACHE_KEY, tag);
  } catch (err) {
    console.error("Local storage error:", err);
  }
};

const loadServiceStatus = async () => {
  stateLoading.value = true;
  try {
    const snap = await getServiceStatus();
    consumeSnapshot(snap);
  } catch (err) {
    setBanner('error', `加载服务状态失败：${err.message}`);
  } finally {
    stateLoading.value = false;
  }
};

const loadLogs = async () => {
  logsLoading.value = true;
  try {
    const payload = await getMosdnsLogs();
    const entries = Array.isArray(payload.entries) ? payload.entries : [];
    logsEntries.value = entries.filter((item) =>
      typeof item.message === 'string' && item.message.includes('[mosdns]'),
    );
  } catch (err) {
    setBanner('error', `获取日志失败：${err.message}`);
  } finally {
    logsLoading.value = false;
  }
};

const openLogsModal = () => {
  logsModalOpen.value = true;
  loadLogs();
};

const closeLogsModal = () => {
  logsModalOpen.value = false;
};

const loadConfigStatus = async () => {
  try {
    const status = await getMosdnsConfigStatus();
    if (status.path) {
      config.path = status.path;
    }
    config.exists = Boolean(status.exists);
    if (status.modTime) {
      config.lastSynced = formatTime(status.modTime);
    }
    if (!config.exists) {
      setBanner('error', '未检测到 mosdns 配置，请先下载配置文件。');
      openModal('缺少配置文件', '尚未找到 mosdns 配置，请下载官方模板并放置到指定路径后重试。');
    }
  } catch (err) {
    setBanner('error', `检测配置失败：${err.message}`);
  }
};

const loadSettings = async () => {
  settingsLoading.value = true;
  try {
    const resp = await getSettings();
    if (resp.settings) {
      applySettingsFromServer(resp.settings);
    }
    applySettings();
  } catch (err) {
    setBanner('error', `加载前端设置失败：${err.message}`);
  } finally {
    settingsLoading.value = false;
  }
};

const applySettingsFromServer = (serverSettings) => {
  const normalizedUi = { ...uiSettings };
  if (Object.prototype.hasOwnProperty.call(serverSettings, 'autoRefreshLogs')) {
    normalizedUi.autoRefreshLogs = normalizeBool(
      serverSettings.autoRefreshLogs,
      normalizedUi.autoRefreshLogs,
    );
  }
  uiSettings.autoRefreshLogs = normalizedUi.autoRefreshLogs; // Update reactive object
  const normalizedForm = normalizeSettingsPayload(serverSettings);
  Object.assign(settingsForm, normalizedForm); // Update reactive object
  Object.assign(preferencesDraft, createPreferencesDraft(normalizedForm)); // Update reactive object
};

const applySettings = () => {
  const enabled = normalizeBool(uiSettings.autoRefreshLogs, true);
  uiSettings.autoRefreshLogs = enabled;
  if (enabled) {
    startAutoLogRefresh();
  } else {
    stopAutoLogRefresh();
  }
};

const saveComponentSettings = async (partial) => {
  if (!partial || Object.keys(partial).length === 0) {
    return;
  }
  settingsSaving.value = true;
  const payload = {};
  Object.entries(partial).forEach(([key, value]) => {
    if (typeof value === 'boolean') {
      payload[key] = value ? 'true' : 'false';
    } else if (value != null) {
      payload[key] = String(value);
    }
  });
  try {
    await saveSettings(payload);
  } catch (err) {
    setBanner('error', `保存设置失败：${err.message}`);
  } finally {
    settingsSaving.value = false;
  }
};

const consumeSnapshot = (snap) => {
  if (!snap) return;
  const status = (snap.status || 'unknown').toLowerCase();
  mosdns.status = status;
  mosdns.running = status === 'running';
  mosdns.lastUpdated = formatTime(snap.lastUpdated);
  config.lastSynced = mosdns.lastUpdated;
  if (typeof snap.version === 'string') {
    const normalizedVersion = snap.version.trim();
    if (normalizedVersion) {
      mosdns.version = normalizedVersion;
    }
  }
  if (status === 'missing') {
    mosdns.version = '未安装';
    setBanner('error', '未检测到 mosdns 核心，请先执行“检查更新”或“一键更新”。');
  }
};

const toggleMosdns = async (state) => {
  if ((state && !canStart.value) || (!state && !canStop.value)) {
    return;
  }
  actionPending.value = true;
  pendingAction.value = state ? 'start' : 'stop';
  try {
    const snap = await (state ? startMosdns() : stopMosdns());
    consumeSnapshot(snap);
    setBanner('success', `mosdns 已${state ? '启动' : '停止'}`);
    loadLogs();
  } catch (err) {
    setBanner('error', err.message);
  } finally {
    actionPending.value = false;
    pendingAction.value = '';
  }
};

const handleStartOrRestart = async () => {
  if (isRunning.value) {
    await performAction('restart');
  } else {
    await performAction('start');
  }
};

const performAction = async (action) => {
  if (action === 'start' && !canStart.value) {
    return;
  }
  if (action === 'restart' && !isRunning.value) {
    return;
  }
  actionPending.value = true;
  pendingAction.value = action;
  try {
    const snap = await (action === 'restart' ? restartMosdns() : startMosdns());
    consumeSnapshot(snap);
    setBanner('success', `mosdns 已${action === 'restart' ? '重启' : '启动'}`);
    await loadLogs();
  } catch (err) {
    setBanner('error', err.message);
  } finally {
    actionPending.value = false;
    pendingAction.value = '';
  }
};

const refreshVersion = async (silent = false) => {
  if (mosdns.checking) return;
  mosdns.checking = true;
  if (!silent) {
    setBanner('info', '正在检测 mosdns 最新版本…');
  }
  try {
    const release = await getLatestMosdnsKernel();
    const tag = normalizeTag(release);
    if (tag) {
      persistLatestVersion(tag);
      mosdns.latestVersion = tag;
    }
    if (!silent) {
      setBanner('success', '已获取最新版本信息');
    }
  } catch (err) {
    if (!silent) {
      setBanner('error', `检测失败：${err.message}`);
    }
  } finally {
    mosdns.checking = false;
  }
};

const applyLatest = async () => {
  if (updatePending.value) return;
  if (!updateAvailable.value && !isMissing.value) return;
  updatePending.value = true;
  setBanner('info', '正在下载并更新 mosdns 内核…');
  try {
    const payload = await updateMosdnsKernel();
    const tag = normalizeTag(payload.release);
    if (tag) {
      mosdns.latestVersion = tag;
      persistLatestVersion(tag);
    }
    if (payload.binary) {
      setBanner('success', `更新完成，已写入 ${payload.binary}`);
      openModal('内核更新完成', `mosdns 已安装到 ${payload.binary}，请视需要启动服务。`);
    } else {
      setBanner('success', '更新完成');
      openModal('内核更新完成', 'mosdns 已成功更新。');
    }
    mosdns.status = 'stopped';
    mosdns.running = false;
    mosdns.lastUpdated = formatTime(new Date());
    await loadServiceStatus();
    await loadConfigStatus();
    await loadLogs();
  } catch (err) {
    setBanner('error', `更新失败：${err.message}`);
  } finally {
    updatePending.value = false;
  }
};

const previewConfig = () => {
  openPreviewModal();
  loadPreviewContent();
};

const performDownloadConfig = async () => {
  if (configDownloading.value) return;
  configDownloading.value = true;
  startProgressTicker('configDownloadProgress', { initial: 5, step: 5, interval: 400 });
  setBanner('info', '正在下载官方 mosdns 配置…');
  try {
    const status = await downloadMosdnsConfig();
    stopProgressTicker('configDownloadProgress', 100);
    setBanner('success', '配置下载完成并已解压');
    if (status && status.path) {
      openModal('配置下载完成', `mosdns 配置已写入 ${status.path}，可继续编辑或启动服务。`);
    }
    const guideSteps = Array.isArray(status?.guideSteps) ? status.guideSteps : [];
    appendGuideHistory(guideSteps);
    await loadConfigStatus();
  } catch (err) {
    stopProgressTicker('configDownloadProgress', 0);
    setBanner('error', `下载失败：${err.message}`);
  } finally {
    setTimeout(() => {
      configDownloading.value = false;
      configDownloadProgress.value = 0; // Use value from progressTickers
    }, 600);
  }
};

const handleDownloadConfig = () => {
  if (configDownloading.value) return;
  if (usingDefaultPreferences.value) {
    downloadConfirmOpen.value = true;
    return;
  }
  performDownloadConfig();
};

const cancelDownloadConfirm = () => {
  downloadConfirmOpen.value = false;
};

const proceedDownloadWithDefaults = () => {
  downloadConfirmOpen.value = false;
  performDownloadConfig();
};

const modifyPreferencesInstead = () => {
  downloadConfirmOpen.value = false;
  openPreferencesModal();
};

const appendGuideHistory = (steps) => {
  if (!Array.isArray(steps) || steps.length === 0) {
    return;
  }
  const entry = {
    ts: Date.now(),
    steps: steps.map((step) => ({
      title: step.title,
      detail: step.detail,
      success: Boolean(step.success),
    })),
  };
  guideHistory.value = [entry, ...guideHistory.value].slice(0, 10);
};

const openGuideLog = () => {
  if (!hasGuideHistory.value) return;
  guideLogModalOpen.value = true;
};

const closeGuideLog = () => {
  guideLogModalOpen.value = false;
};

const openPreferencesModal = () => {
  Object.assign(preferencesDraft, createPreferencesDraft(settingsForm));
  preferencesModalOpen.value = true;
};

const closePreferencesModal = () => {
  preferencesModalOpen.value = false;
};

const savePreferencesFromModal = async () => {
  const success = await saveConfigPreferences(preferencesDraft);
  if (success) {
    setTimeout(() => {
      if (preferencesModalOpen.value) {
        closePreferencesModal();
      }
    }, 600);
  }
};

const openConfigEditor = () => {
  configEditValue.value = config.path || '';
  configEditModalOpen.value = true;
};

const closeConfigEditor = () => {
  configEditModalOpen.value = false;
};

const saveConfigPath = async () => {
  const value = (configEditValue.value || '').trim();
  if (!value) {
    setBanner('error', '配置路径不能为空');
    return;
  }
  configSaving.value = true;
  try {
    await updateConfigPath(value);
    setBanner('success', '配置路径已更新');
    closeConfigEditor();
    await loadConfigStatus();
  } catch (err) {
    setBanner('error', `更新配置路径失败：${err.message}`);
  } finally {
    configSaving.value = false;
  }
};

const handleAutoRefreshToggle = () => {
  applySettings();
  saveComponentSettings({ autoRefreshLogs: uiSettings.autoRefreshLogs });
};

const saveConfigPreferences = async (values) => {
  const normalized = normalizeSettingsPayload(values || settingsForm);
  Object.assign(settingsForm, normalized); // Update reactive object
  settingsSaving.value = true;
  startProgressTicker('settingsSaveProgress', { initial: 12, step: 6, interval: 220 });
  let success = false;
  try {
    await saveComponentSettings({
      fakeIpRange: normalized.fakeIpRange,
      domesticDns: normalized.domesticDns,
      forwardEcsAddress: normalized.forwardEcsAddress,
      proxyInboundAddress: normalized.proxyInboundAddress,
      enableSocks5: normalized.enableSocks5,
      socks5Address: normalized.socks5Address,
    });
    stopProgressTicker('settingsSaveProgress', 100);
    Object.assign(preferencesDraft, createPreferencesDraft(normalized)); // Update reactive object
    setBanner('success', '配置偏好已保存，下一次下载将自动应用。');
    success = true;
  } catch (err) {
    stopProgressTicker('settingsSaveProgress', 0);
    setBanner('error', `保存偏好失败：${err.message}`);
  } finally {
    setTimeout(() => {
      settingsSaveProgress.value = 0; // Use value from progressTickers
    }, 800);
    settingsSaving.value = false;
  }
  return success;
};

const openPreviewModal = () => {
  previewModalOpen.value = true;
  previewLoading.value = true;
  previewError.value = '';
  previewSaving.value = false;
  previewExpanded.value = {}; // Reset reactive object directly
  previewTree.value = [];
  previewFlatList.value = [];
  previewActiveFile.value = '';
  previewEditingContent.value = '';
  previewDir.value = '';
};

const closePreviewModal = () => {
  previewModalOpen.value = false;
};

const loadPreviewContent = async () => {
  previewLoading.value = true;
  previewError.value = '';
  try {
    const payload = await getMosdnsConfigContent();
    previewTree.value = Array.isArray(payload.tree) ? payload.tree : [];
    previewDir.value = payload.dir || '';
    previewExpanded.value = {};
    updatePreviewList();
    const firstFile = previewFlatList.value.find((item) => !item.isDir);
    if (firstFile) {
      previewActiveFile.value = firstFile.path;
      previewEditingContent.value = firstFile.content || '';
    } else {
      previewActiveFile.value = '';
      previewEditingContent.value = '';
    }
  } catch (err) {
    previewError.value = err.message;
    previewTree.value = [];
    previewFlatList.value = [];
    previewActiveFile.value = '';
    previewEditingContent.value = '';
  } finally {
    previewLoading.value = false;
  }
};

const updatePreviewList = () => {
  previewFlatList.value = flattenPreviewNodes(previewTree.value, 0);
};

const flattenPreviewNodes = (nodes, level) => {
  if (!nodes) return [];
  const list = [];
  nodes.forEach((node) => {
    const key = previewNodeKey(node);
    const isExpanded = previewExpanded.value[key] !== false;
    const item = {
      name: node.name,
      path: node.path,
      isDir: !!node.isDir,
      content: node.content,
      level,
      key,
      children: node.children || [],
      expanded: isExpanded,
    };
    list.push(item);
    if (item.isDir && isExpanded) {
      list.push(...flattenPreviewNodes(item.children, level + 1));
    }
  });
  return list;
};

const previewNodeKey = (node) => {
  return node.path || node.name || '';
};

const handlePreviewNodeClick = (item) => {
  if (item.isDir) {
    previewExpanded.value[item.key] = !item.expanded;
    updatePreviewList();
  } else {
    previewActiveFile.value = item.path;
    previewEditingContent.value = item.content || '';
  }
};

const handlePreviewInput = (event) => {
  previewEditingContent.value = event.target.value;
};

const savePreviewFile = async () => {
  if (!previewActiveFile.value) return;
  previewSaving.value = true;
  startProgressTicker('previewSaveProgress', { initial: 15, step: 7, interval: 200 });
  try {
    await saveMosdnsConfigFile(previewActiveFile.value, previewEditingContent.value);
    updateTreeContent(previewActiveFile.value, previewEditingContent.value);
    setBanner('success', `${previewActiveFile.value} 已保存`);
    stopProgressTicker('previewSaveProgress', 100);
  } catch (err) {
    stopProgressTicker('previewSaveProgress', 0);
    setBanner('error', `保存失败：${err.message}`);
  } finally {
    previewSaving.value = false;
    setTimeout(() => {
      previewSaveProgress.value = 0; // Use value from progressTickers
    }, 800);
  }
};

const updateTreeContent = (path, content) => {
  const update = (nodes) => {
    if (!nodes) return;
    nodes.forEach((node) => {
      if (node.path === path && !node.isDir) {
        node.content = content;
      }
      if (node.children) {
        update(node.children);
      }
    });
  };
  update(previewTree.value);
  updatePreviewList();
};

const reloadPreview = () => {
  loadPreviewContent();
};

const startAutoLogRefresh = () => {
  stopAutoLogRefresh();
  autoRefreshTimer.value = setInterval(() => {
    loadLogs();
  }, 8000);
};

const stopAutoLogRefresh = () => {
  if (autoRefreshTimer.value) {
    clearInterval(autoRefreshTimer.value);
    autoRefreshTimer.value = null;
  }
};

// --- Computed Properties ---
const updateAvailable = computed(() => {
  if (!mosdns.version || !mosdns.latestVersion) return false;
  return mosdns.version !== mosdns.latestVersion;
});
const isMissing = computed(() => mosdns.status === 'missing');
const isRunning = computed(() => mosdns.status === 'running');
const canStart = computed(() => !isMissing.value && !isRunning.value && config.exists);
const startButtonLabel = computed(() => {
  if (actionPending.value && pendingAction.value === 'start') return '启动中…';
  if (actionPending.value && pendingAction.value === 'restart') return '重启中…';
  if (isRunning.value) return '重启';
  return '启动';
});
const startButtonDisabled = computed(() => {
  if (actionPending.value) return true;
  if (isRunning.value) return false;
  return !canStart.value;
});
const canStop = computed(() => isRunning.value);
const statusClass = computed(() => {
  if (isRunning.value) return 'online';
  if (isMissing.value) return 'missing';
  return 'offline';
});
const statusLabel = computed(() => {
  if (isRunning.value) return '正在运行';
  if (isMissing.value) return '未安装';
  return '已停止';
});
const previewDisplayedContent = computed(() => previewEditingContent.value);
const previewDirLabel = computed(() => {
  if (previewDir.value) return previewDir.value;
  if (config.path) {
    const parts = config.path.split('/');
    parts.pop();
    return parts.join('/') || '/';
  }
  return '未知目录';
});
const usingDefaultPreferences = computed(() => {
  const fakeDefault = (settingsForm.fakeIpRange || '').trim() === DEFAULT_FAKEIP_RANGE;
  const dnsDefault = (settingsForm.domesticDns || '').trim() === DEFAULT_DOMESTIC_DNS;
  const addrDefault = (settingsForm.socks5Address || '').trim() === DEFAULT_SOCKS5_ADDRESS;
  const proxyDefault =
    (settingsForm.proxyInboundAddress || '').trim() === DEFAULT_PROXY_INBOUND;
  const forwardDefault =
    (settingsForm.forwardEcsAddress || '').trim() === DEFAULT_FORWARD_ECS;
  return fakeDefault && dnsDefault && addrDefault && proxyDefault && forwardDefault;
});
const hasGuideHistory = computed(() => Array.isArray(guideHistory.value) && guideHistory.value.length > 0);

// Provide state/methods to child components (MosdnsOverview, MosdnsListManagement)
provide('mosdnsState', { mosdns, config, uiSettings, settingsForm, guideHistory });
provide('mosdnsActions', {
  loadServiceStatus, loadConfigStatus, loadLogs, saveComponentSettings,
  openModal, openLogsModal, handleStartOrRestart, toggleMosdns,
  refreshVersion, applyLatest, previewConfig, handleDownloadConfig,
  openGuideLog, openPreferencesModal, openConfigEditor, saveConfigPreferences,
  appendGuideHistory,
});
provide('modalControls', {
  openModal, closeModal, openLogsModal, closeLogsModal,
  openConfigEditor, closeConfigEditor, openPreferencesModal, closePreferencesModal,
  openPreviewModal, closePreviewModal, openGuideLog, closeGuideLog,
});
// Special provides for list management
provide('listApi', { getListContent, saveListContent, updateAdguardRules });

// --- Lifecycle Hooks ---
onMounted(() => {
  restoreLatestVersion();
  loadServiceStatus();
  loadConfigStatus();
  loadSettings();
  loadLogs(); // Initial log load
  applySettings(); // Start/stop auto log refresh based on settings
});

onUnmounted(() => {
  stopAutoLogRefresh();
  stopAllProgressTickers();
});
</script>

<template>
  <!-- Global Info Modal -->
  <BaseModal v-model="showInfoModal.open" :title="showInfoModal.title">
    <p>{{ showInfoModal.message }}</p>
    <template #actions>
      <button class="btn primary" @click="closeModal">我知道了</button>
    </template>
  </BaseModal>

  <!-- Logs Modal -->
  <BaseModal v-model="logsModalOpen" title="mosdns 运行日志" size="logs">
    <div class="log-list modal__logs" v-if="logsEntries.length">
      <div class="log-item" v-for="item in logsEntries" :key="item.timestamp + item.message">
        <time>{{ formatTime(item.timestamp) }}</time>
        <span>{{ item.message }}</span>
      </div>
    </div>
    <p class="muted" v-else>暂无 mosdns 日志。</p>
    <template #actions>
      <button class="btn" @click="loadLogs" :disabled="logsLoading">
        {{ logsLoading ? '刷新中…' : '刷新' }}
      </button>
      <button class="btn primary" @click="closeLogsModal">关闭</button>
    </template>
  </BaseModal>

  <!-- Config Edit Modal -->
  <BaseModal v-model="configEditModalOpen" title="修改配置路径">
    <input
      class="modal__input"
      type="text"
      v-model="configEditValue"
      placeholder="例如 /etc/herobox/mosdns/config.yaml"
    />
    <p class="muted">更新后将以新路径检测配置文件，并据此允许启动 mosdns。</p>
    <template #actions>
      <button class="btn" @click="closeConfigEditor">取消</button>
      <button class="btn primary" @click="saveConfigPath" :disabled="configSaving">
        {{ configSaving ? '保存中…' : '保存' }}
      </button>
    </template>
  </BaseModal>

  <!-- Download Confirm Modal -->
  <BaseModal v-model="downloadConfirmOpen" title="使用默认设置？">
    <p class="muted">当前 FakeIP/国内 DNS/SOCKS5 仍为默认值，下载配置时可能需要手动调整。</p>
    <p>如需立即修改，请点击“去修改”；若确认继续，将按当前设置写入配置。</p>
    <template #actions>
      <button class="btn" @click="modifyPreferencesInstead">去修改</button>
      <button class="btn primary" @click="proceedDownloadWithDefaults">继续下载</button>
    </template>
  </BaseModal>

  <!-- Guide Log Modal -->
  <BaseModal v-model="guideLogModalOpen" title="向导日志" size="logs">
    <div class="guide-log" v-if="hasGuideHistory">
      <div class="guide-log__entry" v-for="entry in guideHistory" :key="entry.ts">
        <h4>{{ formatTime(entry.ts) }}</h4>
        <ul class="guide-card__list">
          <li v-for="(step, idx) in entry.steps" :key="idx" class="guide-step">
            <span class="guide-step__status" :class="step.success ? 'success' : 'pending'">
              {{ step.success ? '✓' : '…' }}
            </span>
            <div class="guide-step__content">
              <strong>{{ step.title }}</strong>
              <p>{{ step.detail }}</p>
            </div>
          </li>
        </ul>
      </div>
    </div>
    <p class="muted" v-else>暂无历史记录。</p>
    <template #actions>
      <button class="btn primary" @click="closeGuideLog">关闭</button>
    </template>
  </BaseModal>

  <!-- Preferences Modal -->
  <BaseModal v-model="preferencesModalOpen" title="自定义设置">
    <p class="muted">填写 FakeIP IPv6 段与国内 DNS，下载配置时会自动替换相应字段。</p>
    <div class="config-preferences">
      <div class="config-preferences__row">
        <label>FakeIP IPv6 段</label>
        <input
          type="text"
          v-model="preferencesDraft.fakeIpRange"
          placeholder="例如 f2b0::/18"
        />
      </div>
      <div class="config-preferences__row">
        <label>国内 DNS</label>
        <input
          type="text"
          v-model="preferencesDraft.domesticDns"
          placeholder="例如 114.114.114.114"
        />
      </div>
      <div class="config-preferences__row">
        <label>SOCKS5 地址</label>
        <input
          type="text"
          v-model="preferencesDraft.socks5Address"
          placeholder="127.0.0.1:7891"
        />
        <span class="muted">填写 SOCKS5 地址后将自动启用相关规则，留空则视为关闭。</span>
      </div>
      <div class="config-preferences__row">
        <label>forward_nocn_ecs IPv6 /64</label>
        <input
          type="text"
          v-model="preferencesDraft.forwardEcsAddress"
          placeholder="2408:8214:213::1"
        />
        <span class="muted">可填公网 IPv6 /64 段或运营商下发的 DNS IP。</span>
      </div>
      <div class="config-preferences__row">
        <label>Proxy 入站地址</label>
        <input
          type="text"
          v-model="preferencesDraft.proxyInboundAddress"
          placeholder="127.0.0.1:7874"
        />
        <span class="muted">将替换配置中的 Proxy 入站监听地址，默认 127.0.0.1:7874。</span>
      </div>
    </div>
    <template #actions>
      <button class="btn" @click="closePreferencesModal">取消</button>
      <button class="btn primary" @click="savePreferencesFromModal" :disabled="settingsSaving">
        {{ settingsSaving ? '保存中…' : '保存' }}
      </button>
    </template>
    <ProgressBar v-if="settingsSaveProgress > 0" :progress="settingsSaveProgress" />
    <p class="muted" v-if="settingsSaving || settingsSaveProgress > 0">正在写入配置偏好，请稍候…</p>
  </BaseModal>

  <!-- Preview Modal -->
  <BaseModal v-model="previewModalOpen" title="配置预览" size="logs">
    <p class="muted">当前目录：{{ previewDirLabel }}</p>
    <div class="preview-layout" v-if="previewFlatList.length">
      <div class="preview-tree">
        <button
          v-for="node in previewFlatList"
          :key="node.key"
          class="preview-node"
          :class="{ active: !node.isDir && node.path === previewActiveFile }"
          :style="{ paddingLeft: (node.level * 16) + 'px' }"
          @click="handlePreviewNodeClick(node)"
        >
          <span class="preview-node__icon">
            <template v-if="node.isDir">{{ node.expanded ? '▼' : '▶' }}</template>
            <template v-else>•</template>
          </span>
          <span>{{ node.name }}</span>
        </button>
      </div>
      <div class="preview-editor">
        <textarea
          class="modal__textarea"
          :value="previewDisplayedContent"
          @input="handlePreviewInput"
          :readonly="!previewActiveFile"
          placeholder="选择左侧的配置文件以查看和编辑"
        ></textarea>
        <ProgressBar v-if="previewSaveProgress > 0" :progress="previewSaveProgress" />
        <p class="muted" v-if="previewSaving || previewSaveProgress > 0">
          正在写入配置，请稍候…
        </p>
      </div>
    </div>
    <p class="muted" v-else>目录为空或无可预览的配置文件。</p>
    <p class="muted" v-if="previewError">{{ previewError }}</p>
    <template #actions>
      <button class="btn" @click="reloadPreview" :disabled="previewLoading">
        {{ previewLoading ? '读取中…' : '重新加载' }}
      </button>
      <button class="btn" @click="savePreviewFile" :disabled="previewSaving || !previewActiveFile">
        {{ previewSaving ? '保存中…' : '保存' }}
      </button>
      <button class="btn primary" @click="closePreviewModal">关闭</button>
    </template>
  </BaseModal>

  <!-- Mosdns Content -->
  <header class="content__header">
    <div>
      <div class="muted">基础信息</div>
      <h1>Mosdns</h1>
    </div>
  </header>

  <section v-if="mosdnsSection === 'overview'">
    <MosdnsOverview
      :mosdns="mosdns"
      :config="config"
      :ui-settings="uiSettings"
      :settings-form="settingsForm"
      :action-pending="actionPending"
      :pending-action="pendingAction"
      :update-pending="updatePending"
      :config-downloading="configDownloading"
      :config-download-progress="progressTickers.configDownloadProgressValue || 0"
      :guide-history="guideHistory"
      :settings-save-progress="progressTickers.settingsSaveProgressValue || 0"
      @start-or-restart="handleStartOrRestart"
      @toggle-mosdns="toggleMosdns"
      @refresh-version="refreshVersion"
      @apply-latest="applyLatest"
      @open-logs-modal="openLogsModal"
      @preview-config="previewConfig"
      @download-config="handleDownloadConfig"
      @open-guide-log="openGuideLog"
      @open-preferences-modal="openPreferencesModal"
      @open-config-editor="openConfigEditor"
      @toggle-auto-refresh="handleAutoRefreshToggle"
    />
  </section>

  <section v-else-if="mosdnsSection === 'lists'">
    <MosdnsListManagement />
  </section>
</template>

<style scoped>
/* Scoped styles specific to MosdnsPage if needed */
</style>
--- END OF FILE src/views/Mosdns/MosdnsPage.vue ---

--- START OF FILE src/views/Mosdns/MosdnsOverview.vue ---
<script setup>
import { defineProps, defineEmits, computed } from 'vue';
import ProgressBar from '../../components/ProgressBar.vue';
import { DEFAULT_FAKEIP_RANGE, DEFAULT_DOMESTIC_DNS, DEFAULT_SOCKS5_ADDRESS, DEFAULT_PROXY_INBOUND, DEFAULT_FORWARD_ECS } from '../../api.js';

const props = defineProps({
  mosdns: Object,
  config: Object,
  uiSettings: Object,
  settingsForm: Object,
  actionPending: Boolean,
  pendingAction: String,
  updatePending: Boolean,
  configDownloading: Boolean,
  configDownloadProgress: Number, // Value from the parent
  guideHistory: Array,
  settingsSaveProgress: Number, // Value from the parent
});

const emit = defineEmits([
  'start-or-restart',
  'toggle-mosdns',
  'refresh-version',
  'apply-latest',
  'open-logs-modal',
  'preview-config',
  'download-config',
  'open-guide-log',
  'open-preferences-modal',
  'open-config-editor',
  'toggle-auto-refresh',
]);

const updateAvailable = computed(() => {
  if (!props.mosdns.version || !props.mosdns.latestVersion) return false;
  return props.mosdns.version !== props.mosdns.latestVersion;
});
const isMissing = computed(() => props.mosdns.status === 'missing');
const isRunning = computed(() => props.mosdns.status === 'running');
const canStart = computed(() => !isMissing.value && !isRunning.value && props.config.exists);
const startButtonLabel = computed(() => {
  if (props.actionPending && props.pendingAction === 'start') return '启动中…';
  if (props.actionPending && props.pendingAction === 'restart') return '重启中…';
  if (isRunning.value) return '重启';
  return '启动';
});
const startButtonDisabled = computed(() => {
  if (props.actionPending) return true;
  if (isRunning.value) return false;
  return !canStart.value;
});
const canStop = computed(() => isRunning.value);
const statusClass = computed(() => {
  if (isRunning.value) return 'online';
  if (isMissing.value) return 'missing';
  return 'offline';
});
const statusLabel = computed(() => {
  if (isRunning.value) return '正在运行';
  if (isMissing.value) return '未安装';
  return '已停止';
});

const usingDefaultPreferences = computed(() => {
  const fakeDefault = (props.settingsForm.fakeIpRange || '').trim() === DEFAULT_FAKEIP_RANGE;
  const dnsDefault = (props.settingsForm.domesticDns || '').trim() === DEFAULT_DOMESTIC_DNS;
  const addrDefault = (props.settingsForm.socks5Address || '').trim() === DEFAULT_SOCKS5_ADDRESS;
  const proxyDefault =
    (props.settingsForm.proxyInboundAddress || '').trim() === DEFAULT_PROXY_INBOUND;
  const forwardDefault =
    (props.settingsForm.forwardEcsAddress || '').trim() === DEFAULT_FORWARD_ECS;
  return fakeDefault && dnsDefault && addrDefault && proxyDefault && forwardDefault;
});
const hasGuideHistory = computed(() => Array.isArray(props.guideHistory) && props.guideHistory.length > 0);
</script>

<template>
  <div class="cards">
    <article class="card">
      <h2>运行状态</h2>
      <div class="status" :class="statusClass">
        <span class="status-dot"></span>
        {{ mosdns.lastUpdated === '-' ? statusLabel : mosdns.status === 'running' ? '正在运行' : '已停止'}}
      </div>
      <div class="muted">最近更新：{{ mosdns.lastUpdated }}</div>
      <div class="muted" v-if="isMissing">未检测到 mosdns 核心，请先更新/安装内核。</div>
      <ul class="status-meta">
        <li>
          <span class="status-meta__label">当前配置</span>
          <span class="status-meta__value" :title="config.path">{{ config.path }}</span>
        </li>
        <li>
          <span class="status-meta__label">配置状态</span>
          <span class="status-meta__value">{{ config.exists ? '已就绪' : '缺失' }}</span>
        </li>
        <li>
          <span class="status-meta__label">日志刷新</span>
          <span class="status-meta__value">{{ uiSettings.autoRefreshLogs ? '自动' : '手动' }}</span>
        </li>
        <li>
          <span class="status-meta__label">上次同步</span>
          <span class="status-meta__value">{{ config.lastSynced }}</span>
        </li>
      </ul>
      <div class="button-row">
        <button
          class="btn primary"
          @click="emit('start-or-restart')"
          :disabled="startButtonDisabled"
        >
          {{ startButtonLabel }}
        </button>
        <button class="btn" @click="emit('toggle-mosdns', false)" :disabled="!canStop || actionPending">
          {{ actionPending && pendingAction === 'stop' ? '停止中…' : '停止' }}
        </button>
      </div>
    </article>

    <article class="card">
      <h2>mosdns 版本号</h2>
      <div class="version-tag">{{ mosdns.version }}</div>
      <div class="muted">最新稳定版：{{ mosdns.latestVersion }}</div>
      <div class="button-row">
        <button class="btn primary" @click="emit('refresh-version', false)" :disabled="mosdns.checking">
          {{ mosdns.checking ? '检测中...' : '检查更新' }}
        </button>
        <button class="btn" @click="emit('apply-latest')" :disabled="(!updateAvailable && !isMissing) || updatePending">
          {{ updatePending ? '更新中…' : '一键更新' }}
        </button>
      </div>
    </article>

    <article class="card">
      <div class="card__header">
        <h2>配置管理</h2>
        <div class="card__actions">
          <button class="btn" @click="emit('open-logs-modal')">查看日志</button>
        </div>
      </div>
      <p class="muted">当前配置：{{ config.path }}</p>
      <div class="muted">最近同步：{{ config.lastSynced }}</div>
      <div class="muted" v-if="!config.exists">
        未检测到配置文件，请先下载模板并放置到上述路径后再启动 mosdns。
      </div>
      <div class="setting-row">
        <label class="switch">
          <input type="checkbox" v-model="uiSettings.autoRefreshLogs" @change="emit('toggle-auto-refresh')" />
          自动刷新日志
        </label>
        <span class="muted">{{ uiSettings.autoRefreshLogs ? '日志将在后台自动刷新' : '关闭自动刷新以减少请求' }}</span>
      </div>
      <div class="button-row">
        <button class="btn" @click="emit('preview-config')">配置编辑</button>
        <button
          class="btn primary"
          @click="emit('download-config')"
          :disabled="configDownloading"
        >{{ configDownloading ? '下载中…' : (config.exists ? '重新下载' : '下载配置') }}</button>
        <button
          class="btn"
          v-if="hasGuideHistory"
          @click="emit('open-guide-log')"
        >向导日志</button>
      </div>
      <ProgressBar v-if="configDownloading" :progress="configDownloadProgress" />
      <p class="muted" v-if="configDownloading">下载进度：{{ Math.min(100, Math.round(configDownloadProgress)) }}%</p>
      <p class="muted" v-if="hasGuideHistory">
        最新向导结果已记录，可通过“向导日志”查看详细步骤。
      </p>
    </article>

    <article class="card">
      <h2>自定义设置</h2>
      <p class="muted">FakeIP IPv6 段：{{ settingsForm.fakeIpRange }}</p>
      <p class="muted">国内 DNS：{{ settingsForm.domesticDns }}</p>
      <p class="muted">SOCKS5 代理：{{ settingsForm.enableSocks5 ? '启用' : '关闭' }}</p>
      <p class="muted">SOCKS5 地址：{{ settingsForm.socks5Address || '未设置' }}</p>
      <p class="muted">forward_nocn_ecs：{{ settingsForm.forwardEcsAddress }}</p>
      <p class="muted">Proxy 入站地址：{{ settingsForm.proxyInboundAddress }}</p>
      <p class="muted" v-if="usingDefaultPreferences">当前仍为默认值，下载前建议调整。</p>
      <div class="button-row">
        <button class="btn" @click="emit('open-config-editor')">修改路径</button>
        <button class="btn primary" @click="emit('open-preferences-modal')">编辑设置</button>
      </div>
    </article>
  </div>
</template>

<style scoped>
/* Scoped styles for MosdnsOverview.vue */
</style>
--- END OF FILE src/views/Mosdns/MosdnsOverview.vue ---

--- START OF FILE src/views/Mosdns/MosdnsListManagement.vue ---
<script setup>
import { ref, reactive, computed, onMounted, inject } from 'vue';
import { LIST_DEFINITIONS } from '../../api.js';

const setBanner = inject('setBanner');
const { getListContent, saveListContent, updateAdguardRules } = inject('listApi');

const listManager = reactive({
  entries: LIST_DEFINITIONS,
  current: LIST_DEFINITIONS[2].tag, // Default to 'greylist'
  content: '',
  loading: false,
  saving: false,
  info: '尚未加载',
  error: '',
  lines: 0,
  changed: false,
  lastSaved: '',
  newEntry: '',
  initialized: {},
});

const currentListMeta = computed(() => {
  return listManager.entries.find((item) => item.tag === listManager.current) || listManager.entries[0];
});

const setActiveList = (tag) => {
  if (listManager.current === tag) return;
  listManager.current = tag;
  listManager.content = '';
  listManager.info = '正在加载…';
  listManager.error = '';
  listManager.lastSaved = '';
  listManager.newEntry = '';
  ensureListLoaded(tag, true);
};

const ensureListLoaded = async (tag, force = false) => {
  const initMap = listManager.initialized || {};
  if (!force && initMap[tag]) return;
  await loadList(tag);
};

const loadList = async (tag) => {
  listManager.loading = true;
  listManager.error = '';
  try {
    const text = await getListContent(tag);
    listManager.content = text.replace(/\r\n/g, '\n').replace(/\s+$/, '');
    updateListStats(false);
    listManager.initialized = {
      ...listManager.initialized,
      [tag]: true,
    };
    listManager.changed = false;
    listManager.lastSaved = '';
  } catch (err) {
    listManager.error = err.message || '加载失败';
    setBanner('error', `${tag} 读取失败：${err.message}`);
  } finally {
    listManager.loading = false;
  }
};

const handleListInput = (event) => {
  listManager.content = event.target.value;
  updateListStats(true);
};

const updateListStats = (markChanged) => {
  const lines = (listManager.content || '')
    .split(/\r?\n/)
    .map((line) => line.trim())
    .filter((line) => line.length > 0);
  listManager.lines = lines.length;
  listManager.info = lines.length ? `共 ${lines.length} 行` : '暂无条目';
  if (markChanged) {
    listManager.changed = true;
  }
};

const appendListEntry = () => {
  const value = (listManager.newEntry || '').trim();
  if (!value) {
    setBanner('error', '请输入要添加的条目');
    return;
  }
  const next = listManager.content ? `${listManager.content}\n${value}` : value;
  listManager.content = next;
  listManager.newEntry = '';
  updateListStats(true);
};

const buildListPayload = () => {
  const values = (listManager.content || '')
    .split(/\r?\n/)
    .map((line) => line.trim())
    .filter((line) => line.length > 0);
  return { values };
};

const saveCurrentList = async () => {
  if (listManager.saving) return;
  const payload = buildListPayload();
  listManager.saving = true;
  listManager.error = '';
  try {
    await saveListContent(listManager.current, payload.values);
    listManager.changed = false;
    listManager.lastSaved = new Date().toLocaleString('zh-CN', { hour12: false }); // Use locale string directly
    setBanner('success', `${currentListMeta.value.name} 已保存`);
    updateListStats(false);
  } catch (err) {
    listManager.error = err.message || '保存失败';
    setBanner('error', `${currentListMeta.value.name} 保存失败：${err.message}`);
  } finally {
    listManager.saving = false;
  }
};

const handleUpdateAdguard = async () => {
  try {
    await updateAdguardRules();
    setBanner('success', 'AdGuard 规则更新任务已触发');
  } catch (err) {
    setBanner('error', `AdGuard 更新失败：${err.message}`);
  }
};

onMounted(() => {
  // Ensure the default list is loaded when component is mounted
  ensureListLoaded(listManager.current);
});
</script>

<template>
  <div class="cards cards--lists">
    <article class="card card--lists">
      <div class="card__header">
        <h2>名单管理</h2>
        <div class="card__actions">
          <button class="btn" @click="loadList(listManager.current)" :disabled="listManager.loading">
            {{ listManager.loading ? '读取中…' : '重新读取' }}
          </button>
          <button class="btn" type="button" @click="handleUpdateAdguard">更新 AdGuard</button>
          <button class="btn primary" @click="saveCurrentList" :disabled="listManager.saving || listManager.loading">
            {{ listManager.saving ? '保存中…' : '保存' }}
          </button>
        </div>
      </div>
      <div class="list-tabs">
        <button
          v-for="entry in listManager.entries"
          :key="entry.tag"
          class="list-tab"
          :class="{ active: entry.tag === listManager.current }"
          type="button"
          @click="setActiveList(entry.tag)"
        >{{ entry.name }}</button>
      </div>
      <p class="muted">使用 mosdns `/plugins/{{ listManager.current }}/*` 接口实时读取与写入名单。</p>
      <div class="greylist-toolbar">
        <input
          type="text"
          class="greylist-input"
          v-model="listManager.newEntry"
          @keyup.enter="appendListEntry"
          :placeholder="currentListMeta.placeholder"
          :disabled="listManager.loading"
        />
        <button class="btn" type="button" @click="appendListEntry" :disabled="listManager.loading">
          添加一行
        </button>
        <span class="muted">{{ listManager.info }}</span>
      </div>
      <textarea
        class="list-textarea"
        :value="listManager.content"
        @input="handleListInput"
        :disabled="listManager.loading"
        placeholder="每行一个条目，例如 full:domain"
      ></textarea>
      <p class="muted" v-if="listManager.error">{{ listManager.error }}</p>
      <p class="muted" v-else>
        <span v-if="listManager.lastSaved">最近保存：{{ listManager.lastSaved }}。</span>
        <span v-if="listManager.changed">存在未保存的修改。</span>
      </p>
    </article>

    <article class="card card--lists">
      <div class="card__header">
        <h2>说明</h2>
      </div>
      <ul class="dashboard-list">
        <li>
          <span>白/黑/灰名单</span>
          <span>支持 `full:domain`、通配符等 mosdns 原生语法。</span>
        </li>
        <li>
          <span>DDNS 列表</span>
          <span>建议仅填 root 域名，实时走本地 forward。</span>
        </li>
        <li>
          <span>客户端 IP</span>
          <span>使用 CIDR 表达式限制访问，例如 `192.168.1.0/24`。</span>
        </li>
        <li>
          <span>AdGuard 更新</span>
          <span>调用 `/plugins/adguard/update` 立即刷新规则。</span>
        </li>
      </ul>
      <p class="muted">若需要新增名单类型，可在 mosdns 子配置追加插件后再扩展前端。</p>
    </article>
  </div>
</template>

<style scoped>
/* Scoped styles for MosdnsListManagement.vue */
.dashboard-list { /* Assuming this class is used within this component specifically */
  list-style: none;
  padding: 0;
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.dashboard-list li {
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.dashboard-list li span:first-child {
  font-weight: 600;
  color: #1f2b3a;
}
.dashboard-list li span:last-child {
  font-size: 13px;
  color: #6b7a90;
}
</style>
--- END OF FILE src/views/Mosdns/MosdnsListManagement.vue ---